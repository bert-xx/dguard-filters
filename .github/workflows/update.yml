name: Update Filters

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Filters
        shell: python
        run: |
          import requests
          
          # Настройки
          source_url = "https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/master/adguard.txt"
          # Список слов для поиска (регистр не важен)
          target_keywords = ["OpenAI", "Google", "Grok", "Claude", "xAI"]
          output_file = "my_filters.txt"
          
          print(f"Загружаю данные из {source_url}...")
          r = requests.get(source_url)
          if r.status_code != 200:
              print(f"Ошибка загрузки: {r.status_code}")
              exit(1)
          
          lines = r.text.splitlines()
          result = []
          active = False
          
          print("--- Поиск разделов ---")
          for line in lines:
              clean = line.strip()
              if not clean: continue
              
              # Проверяем, является ли строка комментарием/заголовком (начинается с ! или #)
              if clean.startswith("!") or clean.startswith("#"):
                  # Проверяем, есть ли одно из ключевых слов в этой строке
                  found = any(k.lower() in clean.lower() for k in target_keywords)
                  
                  if found:
                      active = True
                      result.append(f"\n# --- {clean.lstrip('!# ').strip()} ---")
                      print(f"Добавлен раздел: {clean}")
                  else:
                      # Если это заголовок другого (ненужного) сервиса - выключаем захват
                      active = False
              
              # Если мы внутри нужного раздела, добавляем строку в результат
              if active:
                  # Добавляем строку, если это не заголовок (заголовок мы уже добавили красиво выше)
                  if not (clean.startswith("!") or clean.startswith("#")):
                      result.append(clean)

          if not result:
              print("!!! ОШИБКА: Ничего не найдено.")
              print("Первые 20 строк файла для проверки формата:")
              for l in lines[:20]: print(f"DEBUG: {l}")
              exit(1)

          with open(output_file, "w", encoding="utf-8") as f:
              f.write("\n".join(result).strip())
          
          print(f"Успех! Сохранено {len(result)} строк в {output_file}.")

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add my_filters.txt
          # Фиксируем изменения. Если файл не изменился, скрипт просто завершится успешно.
          git commit -m "Update filters: $(date)" || exit 0
          git push origin main
