name: Update Filters

on:
  workflow_dispatch: # Позволяет запускать вручную кнопкой
  schedule:
    - cron: '0 0 * * *' # Запуск автоматически каждую полночь

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process Filters
        shell: python
        run: |
          import requests
          
          # Настройки
          source_url = "https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/master/adguard.txt"
          target_services = ["OpenAI", "Google", "Grok", "Claude"]
          output_file = "my_filters.txt"
          
          print(f"Загружаю данные из {source_url}...")
          try:
              r = requests.get(source_url)
              lines = r.text.splitlines()
          except Exception as e:
              print(f"Ошибка при загрузке: {e}")
              exit(1)

          result = []
          active = False
          
          for line in lines:
              clean = line.strip()
              if not clean: continue
              
              # Если строка — заголовок сервиса (начинается с !)
              if clean.startswith("!"):
                  # Проверяем, есть ли наше ключевое слово в заголовке
                  is_target = any(t.lower() in clean.lower() for t in target_services)
                  if is_target:
                      active = True
                      result.append(f"\n# --- {clean.replace('!', '').strip()} ---")
                      print(f"Нашел блок: {clean}")
                  else:
                      active = False
              
              if active:
                  result.append(clean)

          if not result:
              print("Ничего не найдено! Проверь названия сервисов.")
              exit(1)

          with open(output_file, "w", encoding="utf-8") as f:
              f.write("\n".join(result).strip())
          
          print(f"Готово. Сохранено {len(result)} строк.")

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add my_filters.txt
          git commit -m "Update filters: $(date)" || exit 0
          git push origin main
